import {
  Component,
  ElementRef,
  OnDestroy,
  ViewChild,
} from '@angular/core';
import { FormsModule } from '@angular/forms';
import { CommonModule } from '@angular/common';
import { Router } from '@angular/router';
import { HotelsService } from '../../core/services/hotels.service';
import { Hotel } from './../../interfaces/hotel.interface';
import {
  PaymentProvider,
  CreatePaymentRequest,
} from './../../interfaces/payment.interface';
import { PaymentService } from '../../core/services/payment.service';
import { ToastrService } from 'ngx-toastr';
import { environment } from '../../../environments/environment';
import {
  loadStripe,
  Stripe,
  StripeCardElement,
  StripeElements,
} from '@stripe/stripe-js';
import { firstValueFrom } from 'rxjs';
import { AuthService } from '../../core/services/auth.service';
import { BookingsService } from '../../core/services/bookings.service';
import { CreateBookingRequest } from '../../interfaces/booking.interface';

type BookingSnapshot = {
  makkahHotel: any;
  madinahHotel: any;
  internationalTransport: any;
  groundTransport: any;
};

import { I18nService } from '../../core/services/i18n.service';

@Component({
  selector: 'app-booking-package',
  standalone: true,
  imports: [CommonModule, FormsModule],
  templateUrl: './booking-package.component.html',
  styleUrls: ['./booking-package.component.css'],
})
export class BookingPackageComponent implements OnDestroy {
  @ViewChild('cardElement')
  set cardElementRef(value: ElementRef<HTMLDivElement> | undefined) {
    this.cardElementHost = value;
    if (value && this.clientSecret) {
      this.mountStripeCard();
    }
  }

  readonly stripeConfig = environment.stripe;

  hotels: Hotel[] = [];
  selectedTripType: 'umrah' | 'hajj' = 'umrah';

  hotelBookedMessage = '';
  transportBookedMessage = '';
  groundBookedMessage = '';

  bookingId = 0;
  totalAmount = 0;

  passenger = {
    firstName: '',
    lastName: '',
    dateOfBirth: '',
    email: '',
    phone: '',
    passport: '',
    passportExpiry: '',
    passportIssuingCountry: '',
    nationality: '',
    gender: 0, // 0 = Male, 1 = Female
  };

  paymentMethod: 'stripe' | 'cash' = 'stripe';

  clientSecret: string | null = null;
  stripe: Stripe | null = null;
  elements: StripeElements | null = null;
  cardElement?: StripeCardElement;
  private cardElementHost?: ElementRef<HTMLDivElement>;

  isFinalizing = false;
  isPaymentProcessing = false;
  paymentError = '';
  paymentSuccess = '';

  constructor(
    private hotelApi: HotelsService,
    private router: Router,
    private paymentService: PaymentService,
    private bookingsService: BookingsService,
    private toastr: ToastrService,
    private auth: AuthService,
    public i18nService: I18nService
  ) {
    this.loadHotels();
    this.ensureBookingId();
    this.loadPassengerData();
    this.checkBookingStatus();
  }

  ngOnDestroy(): void {
    this.cleanupStripe();
  }

  // ---------------- Hotel & Transport Status ----------------
  private loadHotels() {
    this.hotelApi.getHotels().subscribe({
      next: (data) => (this.hotels = data),
      error: (err) => console.error('Error loading hotels', err),
    });
  }

  private checkBookingStatus() {
    const snapshot = this.getBookingSnapshotFromStorage();

    // Hotel status messages
    const makkahBooked = !!snapshot.makkahHotel;
    const madinahBooked = !!snapshot.madinahHotel;

    this.hotelBookedMessage =
      makkahBooked && madinahBooked
        ? '✔ تم حجز الفنادق (مكة والمدينة) بنجاح'
        : makkahBooked
          ? '✔ تم حجز فندق مكة بنجاح'
          : madinahBooked
            ? '✔ تم حجز فندق المدينة بنجاح'
            : '';

    // Transport status messages
    this.transportBookedMessage = snapshot.internationalTransport
      ? '✔ تم حجز الطيران/البحري بنجاح'
      : '';
    this.groundBookedMessage = snapshot.groundTransport
      ? '✔ تم حجز النقل البري بنجاح'
      : '';

    // Calculate total
    if (
      snapshot.makkahHotel &&
      snapshot.madinahHotel &&
      snapshot.internationalTransport &&
      snapshot.groundTransport
    ) {
      this.totalAmount = this.calculateTotalAmount(snapshot);
    }
  }

  // ---------------- Booking Actions ----------------
  chooseTrip(type: 'umrah' | 'hajj') {
    this.selectedTripType = type;
  }

  goToHotelsPage(city?: 'Makkah' | 'Madinah') {
    this.router.navigate(['/hotels'], { queryParams: city ? { city } : {} });
  }

  goToTransportPage(tab: 'international' | 'ground' = 'international') {
    this.router.navigate(['/transport'], { queryParams: { tab } });
  }

  // ---------------- Stripe Payment ----------------
  async finalizeBooking() {
    const snapshot = this.getBookingSnapshot();
    if (!snapshot) return;
    if (!this.isPassengerInfoValid()) return;

    this.totalAmount = this.calculateTotalAmount(snapshot);
    if (this.totalAmount <= 0) {
      this.toastr.error('لا يمكن المتابعة بدون إجمالي تكلفة صالح.', 'خطأ');
      return;
    }

    // Validate Passport Expiry (Must be > 6 months from travel start)
    const travelStartDate = new Date(snapshot.makkahHotel?.checkInDate || new Date());
    const sixMonthsFromTravel = new Date(travelStartDate);
    sixMonthsFromTravel.setMonth(sixMonthsFromTravel.getMonth() + 6);

    if (this.passenger.passportExpiry) {
      const passportExpiry = new Date(this.passenger.passportExpiry);
      if (passportExpiry < sixMonthsFromTravel) {
        this.toastr.error('Passport expiry date must be more than 6 months from the travel date.', 'Error');
        return;
      }
    }

    this.isFinalizing = true;

    try {
      // Create booking only
      const savedBookingId = await this.saveBooking(snapshot);

      console.log('🎯 Booking saved with ID:', savedBookingId);

      if (!savedBookingId) {
        throw new Error('No booking ID returned from server');
      }

      // Navigate to confirmation page with booking ID
      console.log('🚀 Navigating to booking-confirmation with ID:', savedBookingId);
      await this.router.navigate(['/booking-confirmation', savedBookingId]);

      this.isFinalizing = false;

    } catch (err) {
      console.error('❌ Finalize booking error', err);
      this.toastr.error('فشل في حفظ الحجز. الرجاء المحاولة مرة أخرى.', 'خطأ');
      this.isFinalizing = false;
    }
  }

  private async saveBooking(snapshot: BookingSnapshot): Promise<number> {
    // Calculate travel dates from hotel bookings
    const makkahCheckIn = snapshot.makkahHotel?.checkInDate;
    const madinahCheckOut = snapshot.madinahHotel?.checkOutDate;

    const payload: CreateBookingRequest = {
      type: this.selectedTripType === 'umrah' ? 0 : 1, // 0 = Umrah, 1 = Hajj
      travelStartDate: makkahCheckIn || new Date().toISOString(),
      travelEndDate: madinahCheckOut || new Date().toISOString(),
      numberOfTravelers: 1, // Currently supporting single traveler
      makkahHotel: snapshot.makkahHotel,
      madinahHotel: snapshot.madinahHotel,
      internationalTransport: snapshot.internationalTransport,
      groundTransport: snapshot.groundTransport,
      travelers: [
        {
          firstName: this.passenger.firstName,
          lastName: this.passenger.lastName,
          dateOfBirth: this.passenger.dateOfBirth,
          passportNumber: this.passenger.passport,
          passportExpiryDate: this.passenger.passportExpiry,
          passportIssuingCountry: this.passenger.passportIssuingCountry,
          nationality: this.passenger.nationality,
          gender: this.passenger.gender,
          phoneNumber: this.passenger.phone,
          email: this.passenger.email,
          isMainTraveler: true
        }
      ],
      totalPrice: this.totalAmount
    };

    console.log('📤 Sending booking payload:', JSON.stringify(payload, null, 2));

    try {
      const response = await firstValueFrom(this.bookingsService.createBooking(payload));
      console.log('✅ Booking created successfully:', response);
      console.log('📦 Full response object:', JSON.stringify(response, null, 2));

      // Show success message
      this.toastr.success('تم إنشاء الحجز بنجاح! جاري تحويلك للدفع...', 'نجاح');

      // Try different response structures
      let bookingId = null;

      if ((response as any).data?.bookingId) {
        bookingId = (response as any).data.bookingId;
        console.log('✅ Found bookingId in response.data.bookingId:', bookingId);
      } else if ((response as any).data?.id) {
        bookingId = (response as any).data.id;
        console.log('✅ Found bookingId in response.data.id:', bookingId);
      } else if ((response as any).bookingId) {
        bookingId = (response as any).bookingId;
        console.log('✅ Found bookingId in response.bookingId:', bookingId);
      } else if ((response as any).id) {
        bookingId = (response as any).id;
        console.log('✅ Found bookingId in response.id:', bookingId);
      } else if ((response as any).data?.bookingNumber) {
        // WORKAROUND: Backend returns id:null, use bookingNumber instead
        bookingId = (response as any).data.bookingNumber;
        console.warn('⚠️ Using bookingNumber as ID (backend bug!):', bookingId);
      }

      if (!bookingId) {
        console.error('❌ Could not extract booking ID from response:', response);
        throw new Error('Booking ID not found in response');
      }

      return bookingId;
    } catch (error: any) {
      console.error('❌ Booking creation failed:', error);
      console.error('❌ Error details:', error?.error);

      const errorMsg = error?.error?.message || 'فشل إنشاء الحجز. الرجاء المحاولة مرة أخرى.';
      this.toastr.error(errorMsg, 'خطأ');
      throw error;
    }
  }

  private async initStripePayment() {
    this.paymentError = '';

    try {
      const payload: CreatePaymentRequest = {
        bookingId: this.bookingId,
        currency: (this.stripeConfig?.currency || 'usd').toLowerCase(),
        idempotencyKey: `booking-${this.bookingId}-${Date.now()}`,
      };

      const response = await firstValueFrom(
        this.paymentService.createPayment(payload)
      );

      if (!response.clientSecret) {
        throw new Error('لم نستلم client secret من Stripe.');
      }

      this.clientSecret = response.clientSecret;
      this.mountStripeCard();

      this.toastr.info('برجاء إدخال بيانات البطاقة لإتمام الدفع.', 'Stripe');
    } catch (error: any) {
      console.error('Stripe init error', error);

      if (error.status === 404) {
        this.toastr.error('نقطة نهاية الدفع غير موجودة. يرجى الاتصال بالدعم.', 'خطأ');
      } else {
        const errorMsg = error?.error?.message || 'فشل تهيئة الدفع. الرجاء المحاولة مرة أخرى.';
        this.toastr.error(errorMsg, 'خطأ');
      }
      throw error;
    } finally {
      this.isFinalizing = false;
    }
  }

  async confirmStripePayment() {
    if (!this.stripe || !this.cardElement || !this.clientSecret) return;

    this.isPaymentProcessing = true;
    this.paymentError = '';

    const billingName = `${this.passenger.firstName} ${this.passenger.lastName}`.trim();

    try {
      const result = await this.stripe.confirmCardPayment(this.clientSecret, {
        payment_method: {
          card: this.cardElement,
          billing_details: {
            name: billingName || undefined,
            email: this.passenger.email || undefined,
            phone: this.passenger.phone || undefined,
          },
        },
      });

      if (result.error) {
        this.paymentError = result.error.message || 'فشل الدفع.';
        this.toastr.error(this.paymentError, 'Stripe');
        return;
      }

      if (result.paymentIntent?.status === 'succeeded') {
        this.paymentSuccess = 'تم الدفع بنجاح!';
        this.toastr.success(this.paymentSuccess, 'Stripe');
        this.clearBookingCache();
        this.router.navigate(['/booking-confirmation'], {
          queryParams: {
            bookingId: this.bookingId,
            paymentIntentId: result.paymentIntent.id,
          },
        });
      }
    } catch (err) {
      console.error('Stripe confirmation error', err);
      this.paymentError =
        err instanceof Error ? err.message : 'حدث خطأ أثناء الدفع.';
      this.toastr.error(this.paymentError, 'Stripe');
    } finally {
      this.isPaymentProcessing = false;
    }
  }

  // ---------------- Utilities ----------------
  private ensureBookingId() {
    const userData = this.auth.getBookingData();
    if (userData?.bookingId) {
      this.bookingId = userData.bookingId;
    } else {
      // If no booking ID exists in the user data, generate one and save it
      this.bookingId = Math.floor(Math.random() * 1000000);
      this.auth.saveBookingData({
        ...userData,
        bookingId: this.bookingId
      });
    }
  }

  private getBookingSnapshotFromStorage(): BookingSnapshot {
    const userData = this.auth.getBookingData() || {};
    return {
      makkahHotel: userData.makkahHotelData || null,
      madinahHotel: userData.madinahHotelData || null,
      internationalTransport: userData.transportData || null,
      groundTransport: userData.groundData || null,
    };
  }

  private getBookingSnapshot(): BookingSnapshot | null {
    const snapshot = this.getBookingSnapshotFromStorage();

    if (!snapshot.makkahHotel || !snapshot.madinahHotel) {
      this.toastr.warning(
        'يجب حجز فندق في مكة وآخر في المدينة قبل المتابعة.',
        'الفنادق مطلوبة'
      );
      return null;
    }

    if (!snapshot.internationalTransport || !snapshot.groundTransport) {
      this.toastr.warning(
        'يجب إكمال حجز النقل الدولي والنقل البري.',
        'النقل مطلوب'
      );
      return null;
    }

    return snapshot;
  }

  private calculateTotalAmount(data: BookingSnapshot): number {
    const hotelTotals =
      this.coerceAmount(data.makkahHotel?.totalPrice) +
      this.coerceAmount(data.madinahHotel?.totalPrice);
    const transportTotals =
      this.coerceAmount(data.internationalTransport?.totalPrice) +
      this.coerceAmount(data.groundTransport?.totalPrice);
    return hotelTotals + transportTotals;
  }

  private coerceAmount(value: any): number {
    const parsed = Number(value);
    return Number.isFinite(parsed) ? parsed : 0;
  }

  private loadPassengerData() {
    const userData = this.auth.getBookingData();
    if (userData?.passengerData) {
      this.passenger = userData.passengerData;
    }
  }

  savePassengerData() {
    const current = this.auth.getBookingData() || {};
    this.auth.saveBookingData({
      ...current,
      passengerData: this.passenger
    });
  }

  private isPassengerInfoValid(): boolean {
    const requiredFields: Array<keyof typeof this.passenger> = [
      'firstName',
      'lastName',
      'dateOfBirth',
      'email',
      'phone',
      'passport',
      'passportExpiry',
      'passportIssuingCountry',
      'nationality',
    ];

    const missing = requiredFields.filter(
      (f) => !this.passenger[f] || (typeof this.passenger[f] === 'string' && !this.passenger[f].trim())
    );

    if (missing.length) {
      this.toastr.warning('برجاء استكمال بيانات المسافر الأساسية.', 'تنبيه');
      return false;
    }
    return true;
  }

  private async ensureStripeInstance() {
    if (this.stripe) return;
    if (!this.stripeConfig?.publishableKey) {
      throw new Error('Stripe publishable key is missing.');
    }
    this.stripe = await loadStripe(this.stripeConfig.publishableKey);
    if (!this.stripe) throw new Error('تعذر تحميل Stripe.');
  }

  private async mountStripeCard() {
    if (!this.cardElementHost) return;

    await this.ensureStripeInstance();
    if (!this.stripe) return;

    if (this.cardElement) this.cardElement.destroy();

    this.elements = this.stripe.elements();
    this.cardElement = this.elements.create('card', { hidePostalCode: true });
    this.cardElement.mount(this.cardElementHost.nativeElement);
  }

  private cleanupStripe() {
    this.cardElement?.destroy();
    this.cardElement = undefined;
    this.elements = null;
    this.stripe = null;
  }

  private clearBookingCache() {
    this.auth.clearUserBookingData();
  }
}
